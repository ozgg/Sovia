<% unless local_assigns[:preview] %>
    <% adjacent = [entry.previous_entry_for(current_user), entry.next_entry_for(current_user)] %>
    <% unless adjacent[0].nil? && adjacent[1].nil? %>
        <nav class="adjacent-entries">
          <ul aria-label="<%= t('.adjacent') %>">
            <% unless adjacent[0].nil? %>
                <li class="previous"><%= link_to t('.previous'), verbose_entry_path(adjacent[0]), rel: 'prev' %></li>
            <% end %>
            <% unless adjacent[1].nil? %>
                <li class="next"><%= link_to t('.next'), verbose_entry_path(adjacent[1]), rel: 'next' %></li>
            <% end %>
          </ul>
        </nav>
    <% end %>
<% end %>

<article class="entry <%= entry.class.to_s.downcase.gsub('entry::', '') %>">
  <header>
    <figure><%= raw entry_avatar(entry.user) %></figure>
    <h2<%= raw (entry.lucid? ? ' class="lucid"' : '') %>>
      <% if local_assigns[:preview] %>
        <%= link_to entry.parsed_title, verbose_entry_path(entry) %>
    <% else %>
        <%= entry.parsed_title %>
    <% end %>
    </h2>

    <div class="privacy privacy-<%= entry.privacy %>">&nbsp;</div>

    <div class="author">
      <%= user_link entry.user %>,
      <%= t("activerecord.models.#{entry.class.to_s.downcase.gsub('::', '_')}") + ' ' + t('at') %>
      <time datetime="<%= entry.datetime %>"><%= entry.created_at.strftime('%d.%m.%Y, %H:%M') %></time>
      <%= t('activerecord.attributes.entry.lucidity') + ': ' + entry.lucidity.to_s if entry.lucid? %>
    </div>

    <%
       tags = entry.tags.order('canonical_name asc')
       described_tags = []
    %>
    <% if tags.any? %>
      <nav class="tags">
        <h3><%= t('posts.post.tags') %></h3>
        <ul>
          <% tags.each do |tag| %>
            <li><%= tagged_entries_path(tag) %></li>
            <% described_tags << tag unless tag.description.blank? %>
          <% end %>
        </ul>
      </nav>
    <% end %>
  </header>
  <div>
    <% if local_assigns[:preview] %>
        <%= raw parse_body(entry.preview, entry.is_a?(Entry::Article), entry.owned_by?(current_user)) %>
        <% if entry.passages_count > 2 %>
            <p class="more"><%= link_to t('read_more'), verbose_entry_path(entry) %></p>
        <% end %>
    <% else %>
        <%= raw parse_body(entry.body, entry.is_a?(Entry::Article), entry.owned_by?(current_user)) %>
    <% end %>
  </div>
  <footer>
    <div class="permalink"><%= link_to t('.link'), verbose_entry_path(entry) %></div>
    <div class="comments-count"><%= t('comment', count: entry.comments_count) %></div>
  </footer>
  <% if described_tags.any? %>
      <% described_tags.sort! { |a, b| a.name <=> b.name } %>
      <aside>
        <div title="<%= t('.described') %>">i</div>
        <ul aria-label="<%= t('.described') %>">
          <% described_tags.each do |tag| %>
              <li><%= link_to tag.name, dreambook_word_path(letter: tag.letter, word: tag.uri_name) %></li>
          <% end %>
        </ul>
      </aside>
  <% end %>
</article>

<%= render 'layouts/social' unless local_assigns[:preview] || !entry.shareable? %>

<% unless local_assigns[:preview] %>
    <%= render partial: 'entries/comments', locals: { entry: entry } %>
<% end %>