<section>
  <h2><%= t('.heading') %></h2>

  <%= render partial: 'browsers/agents/filter', locals: { filter: Hash.new } %>

  <ul id="found-agents" class="list-of-agents dynamic" data-browser-id="<%= browser.id %>">

  </ul>
</section>

<script>/*<![CDATA[*/
"use strict";

$(function () {
  var $container = $('#found-agents');

  function show_found_agents(agents) {
    $container.html('');

    $(agents).each(function() {
      var agent = $(this)[0]['agent'];
      var $li = $('<li data-url="' + agent['url'] + '">');
      var $data = $('<div class="data">' + agent['html'] + '</div>');

      $li.html('<div class="actions"><button type="button">&plus;</button></div>');
      $li.append($data);
      $container.append($li);
    });
  }

  function add_agent(agent) {
    var $section = $('#browser-agents');
    var $notice = $section.find('div.notice');
    var $container;
    var $li = $('<li>');

    if ($notice) {
      $notice.remove();
      $container = $('<ul class="list-of-agents">');
      $section.append($container);
    } else {
      $container = $section.find('ul.list-of-agents');
    }

    $li.html(agent['html']);
    $container.append($li);
  }

  $('#agents-filter').on('submit', function () {
    $.get($(this).attr('action'), $(this).serialize(), function (response) {
      if (response.hasOwnProperty('data') && response['data'].hasOwnProperty('agents')) {
        show_found_agents(response['data']['agents']);
      }
    }).fail(handle_ajax_failure);

    return false;
  });

  $(document).on('click', '#found-agents > li button', function () {
    var $li = $(this).closest('li');
    var url  = $li.data('url');
    var data = {
      agent: {
        browser_id: $(this).closest('ul').data('browser-id')
      }
    };

    $.ajax(url, {
      method: 'patch',
      data: data,
      success: function(response) {
        if (response.hasOwnProperty('data') && response['data'].hasOwnProperty('agent')) {
          $li.addClass('hidden');
          add_agent(response['data']['agent']);
        }
      }
    }).fail(handle_ajax_failure);
  });
});
/*]]>*/</script>